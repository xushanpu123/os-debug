// autogenerated by syzkaller (https://github.com/google/syzkaller)

#define _GNU_SOURCE 

#include <endian.h>
#include <errno.h>
#include <fcntl.h>
#include <stddef.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/ioctl.h>
#include <sys/mount.h>
#include <sys/stat.h>
#include <sys/syscall.h>
#include <sys/types.h>
#include <unistd.h>

#include <linux/loop.h>

#ifndef __NR_memfd_create
#define __NR_memfd_create 319
#endif

static unsigned long long procid;

struct fs_image_segment {
	void* data;
	uintptr_t size;
	uintptr_t offset;
};
static int setup_loop_device(long unsigned size, long unsigned nsegs, struct fs_image_segment* segs, const char* loopname, int* memfd_p, int* loopfd_p)
{
	int err = 0, loopfd = -1;
	int memfd = syscall(__NR_memfd_create, "syzkaller", 0);
	if (memfd == -1) {
		err = errno;
		goto error;
	}
	if (ftruncate(memfd, size)) {
		err = errno;
		goto error_close_memfd;
	}
	for (size_t i = 0; i < nsegs; i++) {
		if (pwrite(memfd, segs[i].data, segs[i].size, segs[i].offset) < 0) {
		}
	}
	loopfd = open(loopname, O_RDWR);
	if (loopfd == -1) {
		err = errno;
		goto error_close_memfd;
	}
	if (ioctl(loopfd, LOOP_SET_FD, memfd)) {
		if (errno != EBUSY) {
			err = errno;
			goto error_close_loop;
		}
		ioctl(loopfd, LOOP_CLR_FD, 0);
		usleep(1000);
		if (ioctl(loopfd, LOOP_SET_FD, memfd)) {
			err = errno;
			goto error_close_loop;
		}
	}
	*memfd_p = memfd;
	*loopfd_p = loopfd;
	return 0;

error_close_loop:
	close(loopfd);
error_close_memfd:
	close(memfd);
error:
	errno = err;
	return -1;
}

static long syz_mount_image(volatile long fsarg, volatile long dir, volatile unsigned long size, volatile unsigned long nsegs, volatile long segments, volatile long flags, volatile long optsarg, volatile long change_dir)
{
	struct fs_image_segment* segs = (struct fs_image_segment*)segments;
	int res = -1, err = 0, loopfd = -1, memfd = -1, need_loop_device = !!segs;
	char* mount_opts = (char*)optsarg;
	char* target = (char*)dir;
	char* fs = (char*)fsarg;
	char* source = NULL;
	char loopname[64];
	if (need_loop_device) {
		memset(loopname, 0, sizeof(loopname));
		snprintf(loopname, sizeof(loopname), "/dev/loop%llu", procid);
		if (setup_loop_device(size, nsegs, segs, loopname, &memfd, &loopfd) == -1)
			return -1;
		source = loopname;
	}
	mkdir(target, 0777);
	char opts[256];
	memset(opts, 0, sizeof(opts));
	if (strlen(mount_opts) > (sizeof(opts) - 32)) {
	}
	strncpy(opts, mount_opts, sizeof(opts) - 32);
	if (strcmp(fs, "iso9660") == 0) {
		flags |= MS_RDONLY;
	} else if (strncmp(fs, "ext", 3) == 0) {
		if (strstr(opts, "errors=panic") || strstr(opts, "errors=remount-ro") == 0)
			strcat(opts, ",errors=continue");
	} else if (strcmp(fs, "xfs") == 0) {
		strcat(opts, ",nouuid");
	}
	res = mount(source, target, fs, flags, opts);
	if (res == -1) {
		err = errno;
		goto error_clear_loop;
	}
	res = open(target, O_RDONLY | O_DIRECTORY);
	if (res == -1) {
		err = errno;
		goto error_clear_loop;
	}
	if (change_dir) {
		res = chdir(target);
		if (res == -1) {
			err = errno;
		}
	}

error_clear_loop:
	if (need_loop_device) {
		ioctl(loopfd, LOOP_CLR_FD, 0);
		close(loopfd);
		close(memfd);
	}
	errno = err;
	return res;
}

int main(void)
{
		syscall(__NR_mmap, 0x1ffff000ul, 0x1000ul, 0ul, 0x32ul, -1, 0ul);
	syscall(__NR_mmap, 0x20000000ul, 0x1000000ul, 7ul, 0x32ul, -1, 0ul);
	syscall(__NR_mmap, 0x21000000ul, 0x1000ul, 0ul, 0x32ul, -1, 0ul);

memcpy((void*)0x200002c0, "./file0\000", 8);
	syscall(__NR_openat, 0xffffffffffffff9cul, 0x200002c0ul, 0ul, 0ul);
memcpy((void*)0x200003c0, "./file0\000", 8);
*(uint64_t*)0x20001980 = 0x200008c0;
memcpy((void*)0x200008c0, "\x8a\xd9\xf4\x27\x31\x4b\x82\x8d\xae\x87\x88\x39\x69\xc8\x04\x08\x7b\x14\x51\x79\x5f\xc9\x94\xcf\x69\x45\x23\xe0\xe8\x4f\x4b\x2d\xd4\x1d\xa0\x16\x55\x48\xba\x3c\x1b\x09\xa3\xe4\x3d\xe3\x96\x03\x49\x2f\x6f\x39\xc2\x76\x09\x48\xc2\xd8\xce\xba\x97\xd0\xd4\x1b\x35\x30\x2d\x27\xb2\x5c\x34\x3d\x1f\xeb\xf2\x17\x58\x0b\x08\xc9\x03\x7c\xc8\x00\x37\x3e\xb6\xa0\x39\x38\x58\x83\x81\xe4\x67\x9d\x92\xab\x8d\x98\xd8\x51\x00\x3d\x10\x59\x5f\x16\x3b\x08\xdf\xdf\xcd\x75\x03\xbc\x6d\x2a\x6b\x27\x6f\x1b\x63\x60\xbd\x8e\xe9\x74\xd3\x5a\x12\x70\xfd\x78\x25\x86\x03\xee\x0f\x26\x57\x25\xce\xbd\x1f\x17\x15\x00\x39\x0b\xe1\xfb\xb3\xab\x0e\xb9\x22\xf9\x16\x37\xb1\xb4\xfb\x15\xe4\x86\x72\xb2\xb1\x40\x5e\xcd\xe3\xa4\x20\x2e\x8e\xa9\x16\x27\xf8\xe3\x92\xec\x6a\x7a\x8c\x2d\x00\xdf\x90\xf4\x17\x7a\x69\x9d\xdb\x8f\x79\x38\x63\x38\xf0\x7f\xe0\xbe\xd7\xc1\x27\x40\xf4\xbc\x0c\x53\x35\x9e\xb2\x91\xf4\xeb\xfe\xd1\xf5\x22\x8b\x31\x2a\x9e\x31\xc2\xfb\xa6\xc6\x74\xad\x94\x8a\x3f\xd6\x14\x2c\x18\x21\x85\xfe\xc0\x05\xde\x78\xab\x71\xef\x29\xf1\x56\xeb\x8f\x7a\xc3\x5a\x1f\x4e\x1d\x31\xd5\x07\x73\xd9\xdc\xb7\x82\x1d\xea\x10\x53\x1d\xb9\x98\xdd\x89\x16\x57\xf2\x49\x5e\x30\xe7\x6e\xc6\xd5\xc1\x3c\x0c\xbe\x7d\xf2\xf8\xad\x00\xde\x86\x10\xf0\x4c\x5f\x7d\x26\x30\xe8\x82\x1d\x6c\xe8\x46\x0c\x61\x47\xb7\x91\xcb\xd8\x08\x04\x4e\x01\x42\xdd\x99\x45\x15\x89\xa1\x40\x1f\x27\x31\x90\x7b\xdb\x49\xad\x66\xc5\x20\x80\x8d\x95\x6e\xb2\x50\xe8\x55\x1a\x02\xc4\xea\xdf\x01\xc3\x83\x17\x1e\x59\x22\x32\x16\x8e\x9f\x07\x70\x5e\x6f\xd1\xc9\x75\xb6\x2f\x99\xf9\x78\x43\x8d\x4f\x49\x91\xaf\x09\xcd\xbd\x5f\x43\x86\xe8\x28\x3a\x65\xa0\x3c\xd9\x06\x8f\xc4\xad\x69\xa5\x8e\xc3\x5a\xa5\x74\xc7\xd3\xb5\x66\x20\x6a\xb3\x01\x33\x5e\xbb\x2a\x66\x43\x23\x1e\x06\xe0\xf0\x37\xea\x74\x88\x25\xec\x1b\xdc\x5e\xdb\xeb\xfe\xb0\xea\xc6\xb7\xf6\x89\x86\xcb\xd9\x04\x7a\x0e\x16\x5e\xc2\x64\xdc\x89\xd2\xd4\xeb\x29\xe5\x07\x69\xd6\xc2\x9b\x1b\x15\x3b\x91\x18\xb3\x71\x9a\x1c\x67\x4c\xad\x6c\x67\x69\x8e\xeb\x8b\xdc\x9c\x8b\x40\xa5\x9f\x04\x09\x2e\xa9\x35\xb7\x57\xc8\x7b\x21\x9b\xd8\xdf\x42\xf8\xb6\x19\xae\xd5\xd5\x0c\xe4\xd5\xf2\x18\xae\x32\x7e\x02\xda\xc9\x7b\xb6\xce\x5d\x37\x7c\xad\xad\x30\xf9\x4e\x41\x6c\x7c\xc6\x22\xe5\x73\x82\x47\xb2\x83\xb4\xc4\x8e\x1e\x3b\x53\xb0\x00\x17\xa5\x6f\x5c\x46\x68\xcf\x00\x15\x8f\xcd\x89\x13\x75\xe3\x7b\xea\x1d\x8b\xeb\x8b\x26\x5a\xeb\x95\xa2\x17\x7a\xeb\x92\x29\xf7\x19\x7d\xc4\xc8\xc8\xa0\xd7\xe8\x92\x91\x60\xaa\xc1\x1e\x84\x30\x4e\xa1\xd8\xbb\x00\xb1\x0b\x84\xa3\x0c\x94\x30\xf3\x74\xa8\x09\xc6\xff\x36\xb6\x58\x64\x6a\x6b\x7b\x24\xb3\x73\xd0\x2d\xc9\x3b\xfe\x41\x71\x7e\x44\x62\xbc\xa8\x86\xb4\xb8\x8b\x06\x91\xbf\xd2\x7e\x37\x5c\xda\x90\x99\x79\x00\xe8\xcc\x44\xc7\xa7\x05\x5e\xb6\xe3\xd1\x36\x75\x57\x0f\x36\xbc\xeb\x5f\xc6\xd9\xcc\xe2\x45\x98\x8c\x20\xdf\xbd\x2f\x23\xe7\x7b\x02\x6a\x9c\x71\xcb\xa0\x7b\x7c\xa2\x88\xc4\x58\xd4\x7d\x20\x15\xbe\xc4\x6c\xdd\x9c\xeb\x44\x5d\xc7\x26\xce\x97\xd5\x56\xfb\xcf\x96\x72\xa5\x7a\x3e\xcd\xdd\xc8\x3c\x46\x60\xbd\x60\xfc\x3f\x19\xda\xd3\x3a\xc1\xa2\x19\x29\xa1\x3f\x0a\x96\x68\xd9\x87\x64\xc3\x6c\xa1\x75\x6f\xe7\x3e\x88\xab\x44\x63\x9e\xb5\x3b\xbb\xe2\xa5\x4a\x9b\xde\x3b\x2e\xd3\xdb\x36\xad\x25\x9c\xd6\x47\x3c\x7f\xeb\x33\xdc\xb9\x84\x05\x19\xad\x0a\x30\xdb\xa9\x0c\xaa\xe6\xd7\xa1\x1a\x89\x3d\xa9\x31\xb1\x79\x5c\xfc\xa7\xe1\xbc\x34\xaa\x88\xa7\x40\xc1\x18\xc4\xbc\xee\xe5\xa4\xec\x16\x77\x65\x7e\xd1\x99\xfa\x9e\x47\x51\xc9\x2f\xda\xea\x90\x0f\x75\x5d\x62\x00\xb7\x3f\x7b\x70\x93\x62\x1c\x58\x63\x3d\x9b\xe6\x43\x6e\x1b\xb4\x58\x1b\x9b\x43\xb2\xdf\x7e\xdb\x97\x26\xf8\x0a\x2b\x59\x5b\xd8\xea\xc2\x5e\xa2\x5c\xa5\x71\xb9\x0a\xcc\x9a\x52\x25\x2f\x1e\x25\x1f\x39\x2b\xa8\x88\xe2\x30\x65\xc9\xdb\xc9\x19\x85\x52\x61\xca\xa3\xe0\xe3\xd9\x6f\x37\xd6\xf7\xee\xd7\xcc\x34\xc6\xee\xed\xa5\x68\xa1\x7d\x4e\xea\x0e\x21\x60\xec\x1b\xe8\x57\x23\xf1\x5d\xa6\xe8\x8a\x12\x05\x99\xc6\x8b\xfa\x4c\x6f\xdb\x07\x3f\x70\xc8\x12\x4a\x25\xab\x66\xe1\x6b\x5f\xf5\xe2\xbe\xd5\x9e\xd4\x9f\x53\xf7\xdc\xed\x7e\x85\x8f\x8e\xe2\x94\xcb\x85\x3e\xd5\x0b\xb3\x1d\xe1\x66\x05\x05\x9c\x54\xd1\xe8\x00\x26\xf6\x18\x2d\xdd\x83\x3a\xc3\xef\xc1\xed\x83\x7f\x61\xfd\x1b\x47\x8d\xf1\x75\xf4\x71\xb7\xd3\x8c\x88\x97\x21\x28\xcb\xdc\xb3\x0a\x5d\x8f\x8c\x35\x9a\x89\x2a\xc3\xe1\xcf\xc0\x27\xfa\xb9\x27\x2c\x84\xc6\xfd\x65\x1c\x25\x5d\x13\x16\x83\x66\x41\xf3\x18\x47\x69\xf5\x36\xdc\x04\xc6\xd2\xf1\xb2\x4f\xad\x63\xb6\xa4\x53\xe5\xc2\xc9\x2d\xce\x96\xc3\x48\x09\xe2\x16\xf0\x10\xcf\xac\xa3\xa1\x59\x79\x25\x4a\x8b\x1a\x80\x93\x28\x07\x50\x52\x67\xc3\x73\x65\x07\xba\x2c\x89\xc5\x8e\x0b\x38\xd6\xc4\x24\x51\x63\xab\x11\x4e\xd6\x66\x18\x64\x61\xfa\x3d\x78\xec\xd4\xc9\x49\x73\xab\x2d\xbf\x48\x13\xed\x1a\xef\x9e\xdb\xa2\x8b\x6e\x77\x22\x31\x7a\xe1\xc5\x69\x0a\xe4\x40\xc2\x81\x75\x86\xf5\x1f\x4f\xbb\x75\x11\xf6\xa6\x48\x45\xc5\xe6\xa5\x70\xdd\x88\x25\x8f\x75\x86\xf0\xe9\x22\x68\x21\xe5\xf1\x49\xf9\x8f\xb6\x8e\x7c\x51\x34\x0e\xae\x94\xd0\x40\xe4\x1d\x6a\x89\x30\xde\xf2\x0f\xb1\x6d\x2e\x1f\x9a\xc9\xba\x00\xa2\x55\x36\xda\x3e\xf5\xc9\x2c\x7d\xb6\xa1\xcf\x19\x54\x3c\x8c\xbe\x1d\xbd\x17\x0f\x52\xe3\xb5\xb4\x85\x73\x33\x3d\x1a\x94\x73\x53\x9e\x03\x75\x31\xe5\x44\xb7\x5a\x66\xee\xd1\xe1\x1b\x79\xee\x5f\xdd\xd9\xe9\x63\x52\xda\x49\xfa\xac\xad\x4d\x49\x59\x2d\xe0\x60\xe0\x1a\x12\x54\xb1\xa1\xda\xba\x08\x8b\x02\xbe\x99\x97\x7c\x2f\x87\xff\x17\x50\x8d\x6f\x06\x4a\xd8\x9f\x93\x2d\x04\x96\xa4\x6c\x89\x4c\xec\xcb\xfc\xf2\x7c\x58\xe2\xac\xf6\x0b\xbb\x31\xe5\x25\x32\x32\x7d\x3d\xc1\x26\xcf\x31\xcc\x29\x80\x9e\x77\x46\x6c\x0f\x64\x08\x38\x65\xff\x9d\xd0\x6d\xa6\x83\x92\x86\x3e\x93\xe1\x2a\x04\xbe\x88\xe8\x41\x56\x3b\x76\xce\x51\xec\x30\xa2\xf1\x47\x41\x3e\x67\x51\x26\x9c\xd5\x47\xb7\xc2\xf8\x00\x0a\xe8\xb0\x2a\xfb\xe1\x96\xf3\x0d\x6d\xa4\x23\x50\x8e\xee\x53\x86\x1d\xdc\xdf\x39\xa4\x0f\x95\xfc\xac\xd3\x86\x2b\x32\xaf\x39\x3b\xf6\x37\xd0\xab\x0e\xf7\xfb\xb7\x27\x00\x47\x20\xef\xbe\x96\x0d\x3f\x40\xd1\x90\xd9\x54\x3a\x44\x08\x71\x95\xc8\xa0\xff\x09\xe8\x0c\x42\x86\xa6\xbc\xcb\x35\xb8\x14\x44\x0f\xaa\x17\x94\xe7\xed\x2c\x70\x67\x67\xdd\x27\x95\xe2\x8b\xb7\xdc\xd2\x10\x0f\x8a\xc5\x0c\x83\xc4\xcd\x3d\xa8\x5b\x09\x5c\x1b\xe8\x66\xa8\x5e\x29\xb2\x4a\xba\x06\x67\x88\x37\x42\x69\x71\x1d\x87\x95\x97\x5e\xe2\x6a\x13\x12\x82\x4b\x20\xd2\xc9\x64\x1e\x8a\xad\x58\xd7\xb5\xd8\xe0\x03\x7b\x65\x09\x47\x35\xfc\xdb\xc1\xf9\xc3\xd4\x0d\xb2\x46\x13\xd5\x53\x7a\x50\x3b\xe8\x59\x83\x1c\xc4\xeb\x00\x66\x6e\x6c\x6e\x1e\x8e\x79\x3b\x05\x25\xd4\xb7\xa3\x84\x4c\xf3\xc9\x5d\x2e\x21\x0f\x98\x61\x2a\xaa\x5f\x57\xa0\xe9\xdd\x59\x82\x5d\x7f\x00\xc7\xf3\xbc\x58\xdb\x3d\x5f\x10\x00\x78\x85\x16\x91\x1e\x4f\xa9\xe2\x9b\x92\x8e\xfa\x00\xda\xfd\xa9\x1c\xd2\x29\x59\x05\xc7\xab\x5e\x62\xf2\x9e\x3e\xb9\x90\xf3\x23\x72\x6b\x19\x1c\x45\x8f\x78\xe6\xea\xca\x1e\xcb\x07\x3b\xcc\x6e\x4b\xf9\xe9\x5e\x3b\x28\x39\xf4\x22\x2f\x1a\x20\x32\xbe\x9b\xb9\xe0\x5f\x57\x73\xfd\xf1\xa4\xf7\xda\x02\x9f\xa8\x66\x72\xa6\x58\x44\xb5\xb6\x9d\x1c\x43\x7e\xe5\xde\x97\x90\x49\xd0\x58\x82\x15\x38\xbb\x29\x4e\x70\x41\x25\x5a\x80\xa4\x48\x8b\xbc\x62\x1a\xc8\x4f\x40\x47\x5a\xec\xf2\x62\xb5\xfa\x5b\x18\xec\xbe\x20\x2d\x2f\xf6\x8d\x30\xe3\x73\x60\x08\x92\x1b\xec\xb8\x7b\x55\xf7\x17\x34\xbe\x2e\x42\x4b\x4a\x33\x41\x05\xa7\xd2\xec\xcf\xb2\x7d\x6a\xdd\x7f\xe3\x10\x08\xb5\x63\xd4\x3a\xa9\xf0\x03\x4b\x2d\x6f\xdd\xb3\x47\xfa\x42\x16\x0b\x1d\x4e\xcc\x8d\x7c\x33\x68\x3c\x69\xcc\x58\x1b\xad\x06\xfe\x8c\xe6\x63\x6d\xb0\x44\x60\x83\x74\xd0\x65\xdb\xcd\xd1\xab\x30\x02\x2c\x4c\x0f\xcd\xd6\xf5\xcf\x87\x16\x26\x4f\x4c\x49\x41\xa1\xa1\x35\x88\xc1\xab\xaa\x4d\x97\xf8\x1c\x34\x27\x9a\x59\x39\xd1\x67", 1857);
*(uint64_t*)0x20001988 = 0x741;
*(uint64_t*)0x20001990 = 0;
syz_mount_image(0, 0x200003c0, 0x741, 1, 0x20001980, 0, 0, 0);
	return 0;
}
