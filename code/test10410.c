// autogenerated by syzkaller (https://github.com/google/syzkaller)

#define _GNU_SOURCE 

#include <endian.h>
#include <errno.h>
#include <fcntl.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/ioctl.h>
#include <sys/stat.h>
#include <sys/syscall.h>
#include <sys/types.h>
#include <unistd.h>

#include <linux/loop.h>

#ifndef __NR_memfd_create
#define __NR_memfd_create 319
#endif

static unsigned long long procid;

struct fs_image_segment {
	void* data;
	uintptr_t size;
	uintptr_t offset;
};
static int setup_loop_device(long unsigned size, long unsigned nsegs, struct fs_image_segment* segs, const char* loopname, int* memfd_p, int* loopfd_p)
{
	int err = 0, loopfd = -1;
	int memfd = syscall(__NR_memfd_create, "syzkaller", 0);
	if (memfd == -1) {
		err = errno;
		goto error;
	}
	if (ftruncate(memfd, size)) {
		err = errno;
		goto error_close_memfd;
	}
	for (size_t i = 0; i < nsegs; i++) {
		if (pwrite(memfd, segs[i].data, segs[i].size, segs[i].offset) < 0) {
		}
	}
	loopfd = open(loopname, O_RDWR);
	if (loopfd == -1) {
		err = errno;
		goto error_close_memfd;
	}
	if (ioctl(loopfd, LOOP_SET_FD, memfd)) {
		if (errno != EBUSY) {
			err = errno;
			goto error_close_loop;
		}
		ioctl(loopfd, LOOP_CLR_FD, 0);
		usleep(1000);
		if (ioctl(loopfd, LOOP_SET_FD, memfd)) {
			err = errno;
			goto error_close_loop;
		}
	}
	*memfd_p = memfd;
	*loopfd_p = loopfd;
	return 0;

error_close_loop:
	close(loopfd);
error_close_memfd:
	close(memfd);
error:
	errno = err;
	return -1;
}

static long syz_read_part_table(volatile unsigned long size, volatile unsigned long nsegs, volatile long segments)
{
	struct fs_image_segment* segs = (struct fs_image_segment*)segments;
	int err = 0, res = -1, loopfd = -1, memfd = -1;
	char loopname[64];
	snprintf(loopname, sizeof(loopname), "/dev/loop%llu", procid);
	if (setup_loop_device(size, nsegs, segs, loopname, &memfd, &loopfd) == -1)
		return -1;
	struct loop_info64 info;
	if (ioctl(loopfd, LOOP_GET_STATUS64, &info)) {
		err = errno;
		goto error_clear_loop;
	}
	info.lo_flags |= LO_FLAGS_PARTSCAN;
	if (ioctl(loopfd, LOOP_SET_STATUS64, &info)) {
		err = errno;
		goto error_clear_loop;
	}
	res = 0;
	for (unsigned long i = 1, j = 0; i < 8; i++) {
		snprintf(loopname, sizeof(loopname), "/dev/loop%llup%d", procid, (int)i);
		struct stat statbuf;
		if (stat(loopname, &statbuf) == 0) {
			char linkname[64];
			snprintf(linkname, sizeof(linkname), "./file%d", (int)j++);
			if (symlink(loopname, linkname)) {
			}
		}
	}
error_clear_loop:
	ioctl(loopfd, LOOP_CLR_FD, 0);
	close(loopfd);
	close(memfd);
	errno = err;
	return res;
}

int main(void)
{
		syscall(__NR_mmap, 0x1ffff000ul, 0x1000ul, 0ul, 0x32ul, -1, 0ul);
	syscall(__NR_mmap, 0x20000000ul, 0x1000000ul, 7ul, 0x32ul, -1, 0ul);
	syscall(__NR_mmap, 0x21000000ul, 0x1000ul, 0ul, 0x32ul, -1, 0ul);

*(uint64_t*)0x200001c0 = 0x20000140;
memcpy((void*)0x20000140, "\x63\x5a\x0c\xe9\x5f\x15\xc6\x61\xf0\x48\x16\xec\xc2\xbe\x9c\xbd\x6d\x24\xe4\xa9\x26\x56\xbe\xf6\xa1\x0a\xaf\xee\xa5\xf5\xa3\xfd\x44\x66\x9e\x15\xb1\x5c\xf1\xbc\x3b\xb0\xbd\x87\x8a\x67\xed\xef\x80", 49);
*(uint64_t*)0x200001c8 = 0x31;
*(uint64_t*)0x200001d0 = 0x1ff;
*(uint64_t*)0x200001d8 = 0x20000180;
memcpy((void*)0x20000180, "\x07\x05\x83\xca\x73\xb0\x9d\x8a\xc7\x30\x55\xe6\xd7\xf5\x82\xe9\x33\x24\x87\x03\x4c\xe6\x59\x60\x97\x5e\x72\xcc\x8e\x69\xde\x30\x5f\x51\x93\xa9\xc8\x69\x9a\x6b\xd7\x0d\xf4\x7d\xca\xb5", 46);
*(uint64_t*)0x200001e0 = 0x2e;
*(uint64_t*)0x200001e8 = 6;
*(uint64_t*)0x200001f0 = 0x20000400;
memcpy((void*)0x20000400, "\xc5\xe1\xfb\x06\x32\x10\x80\xc6\x6d\x4e\xe6\x78\xb5\x12\x6e\x95\xda\xed\xfd\xa7\x4a\x67\x42\xc2\x94\x1f\xf3\x15\xb3\xaf\x43\x3a\x89\xe1\x60\xe4\x63\xcb\x9a\xca\xba\x8f\x98\x8d\x4b\xe0\x03\x99\x1c\x31\x01\xf4\x93\x8a\x1e\x4b\xf9\x7c\xb6\x21\x25\xb3\x57\x3d\x49\x54\xc4\xac\xc1\x65\x92\x3e\xed\x1e\x91\xda\x1f\x57\xca\xda\xe1\x28\x69\x5c\x2d\xa5\x12\x56\xc8\x63\xe5\x3b\x5a\x46\x1e\x8f\xf5\x59\xd6\x69\x8b\x8a\xc8\x73\xad\x7a\x52\xa2\x3b\x0d\x7d\x73\x8b\x0c\xca\x5e\x48\x27\xfa\x53\x6e\xeb\xb1\x87\x3d\x2d\xfa\x46\x7c\x98\x9e\xd1\xf3\x23\x91\xa2\x86\x36\xee\x80\x17\xdd\x88\xfe\x21\x9a\xb4\x08\x79\x28\x6c\x34\x99\x47\xa3\xaa\xfe\x7d\x43\xe8\x00\x08\xc1\xcf\x28\x93\x96\xeb\x8c\x7f\x25\xb8\x46\xd4\xaa\xe1\xf8\xa2\x1c\x73\xe9\x2a\xb5\x82\x65\xc0\xc2\x1d\x3d\xc5\x8f\x11\x51\x8b\x9f\xcb\xa6\xa2\x7d\x95\xfe\xec\x9b\x92\xd0\xf7\xb0\xcd\xbd\xee\x7b\x18\x75\x32\xd2\xfd\x01\x10\xc7\xb9\x8e\x2f\x2b\x0e\x14\x14\x76\x85\x78\xee\xd0\x5e\x52\xc1\x37\xfb\x37\x34\x88\xff\x68\x38\xb3\x6a\x9d\x14\x68\xfb\x41\x43\x69\x50\x04\x1b\x41\x55\xc1\x5b\x69\x8f\xf8\xb7\xce\x7a\x1e\x44\xbd\x76\x30\x0f\x6a\xce\x5e\x9c\x6e\x0d\x61\x6c\x9c\xfc\x61\xd1\x08\x06\x3e\x71\x9e\x94\x2c\x79\x90\xb7\x1b\xa8\xa7\xc1\x3d\xd1\x34\x0f\xe6\x44\xed\xe8\x78\x7b\x39\xdf\x55\xa9\x86\xdb\xb5\x9d\xb9\x69\x9b\xd1\xc3\x9e\x18\x39\xf2\x53\xfc\x1c\x0e\x22\xfe\x92\x36\xb0\x8a\xea\x47\x41\xae\x9d\xe9\x40\x62\x96\x75\x7e\xa6\x29\x49\xe5\x5c\xb0\xb7\x8c\x00\xe6\x65\x1e\xca\xe9\xcb\x84\x57\x6d\x15\x9e\x3f\x7f\x6b\x4b\x12\x7a\x39\x27\xe4\x4f\xda\x80\x31\xaf\xd2\x5d\xef\x4e\x46\xe8\x7e\x8e\x64\x2e\x9d\xd8\xf7\xf0\x0e\xfc\x15\xcb\x3f\xf8\xc3\xeb\x11\x6b\x2d\xdd\x84\x02\x5d\x57\xcc\xba\x5d\x33\x37\x14\x54\x3b\xf2\x8e\xe7\x2f\x35\xd0\xc5\xe6\x65\x41\x4c\xc0\x95\x25\xd6\xa6\xdc\x09\x56\x59\xd0\x10\xd6\x43\x6d\xe8\xd9\x45\xfc\x0f\x55\x3a\x73\xfb\xf4\xd4\x9f\xe3\xab\x9d\xf9\x7a\x03\xf8\xdf\x00\x80\x45\xab\x30\x0b\x07\x91\x5c\xca\x22\x07\x5e\xe7\x5e\xb9\xf4\x43\x6d\xc4\x49\x65\x5d\x0d\x34\xcc\x5c\x5e\x87\x22\x9e\x0c\x02\x18\x5c\x72\x6e\x20\x5f\xe5\x8e\xb5\x31\x4e\x9a\xd8\x23\xbd\xf6\xd1\x45\x6d\x8d\x1d\x5d\x91\xf4\xd3\x5e\x9d\x4c\xf3\x58\xf5\xfa\xbe\x3f\x99\x28\xf9\x7f\x40\x55\xa9\x8b\xb5\xcf\x02\x45\x00\x97\xfc\x59\x4e\x20\xe4\x6b\x4f\x8d\xd2\x0c\xe5\x90\xd9\x0d\x8a\x08\xe4\x4f\x31\xb6\x40\xc0\x0d\x02\x7f\x9d\x43\x27\x04\x59\x97\xea\x90\xd3\x42\xd8\x13\x97\x52\x21\x38\xf0\xba\xe6\xfc\x0b\xfd\x45\x99\x2c\x38\x83\x11\x00\x47\x79\xe6\xc4\x3d\x13\x35\x60\xd9\xc0\x8a\x0c\x23\xa9\xa3\x1b\x50\xe3\x5c\xe2\xcc\x8c\xa1\xff\xf7\xcb\x46\x92\x7a\xfe\x8e\xaf\x85\x0c\xab\x60\xa4\x4a\x82\xc8\x4e\x82\xb9\xf5\x2d\x72\x5e\x9c\xf3\x7f\x1a\x94\x0f\xc9\x3d\x1e\x3e\xf3\xe7\x62\x19\x80\x82\xf8\xb9\xbc\x24\xf0\x6c\xc5\x1e\x3b\x7e\x97\x35\x0d\x40\xd5\x17\xef\x42\x17\x41\x4a\x76\x5d\x95\x7c\x8b\x02\xee\x36\x64\x5c\xea\x15\xd5\x47\x26\x8d\x49\x4b\x7d\xa6\x06\xb4\xb5\xcc\x00\xb3\x72\xe1\xe4\x99\x83\x84\xbd\xc0\x8a\x14\x52\x7a\x83\xe1\x47\x3e\x5a\x3c\xfc\x99\x36\x1a\x89\xab\x02\x41\x25\xd9\x47\xfc\xde\x49\x02\xfe\x2b\x23\xfe\x50\x59\xf6\xde\xfe\x3b\x42\xf2\x64\x07\x79\x51\xde\x86\x79\x69\x65\xa4\x02\x31\x21\x1c\x4f\xea\x18\x65\x34\x3d\x49\xf2\x7b\x7a\x42\xb1\x73\x53\x1e\xf7\x67\xd7\xca\xe8\x89\x00\x06\x87\x46\x76\x39\x1e\x60\x6a\x31\x1d\x84\x0b\x10\xca\x39\xf3\xa0\x21\xbe\xea\xa8\x78\x50\x62\xd3\x3d\xb1\x65\xba\x48\xca\x39\x5a\x9d\x22\x8a\xd3\x1c\xad\x4a\x68\x3c\xb6\x16\xf8\x63\xa7\x3c\xb9\xaf\xdd\x60\xd2\x5f\x7b\x22\x3b\x8d\x1f\xe9\xf8\x0c\xf6\x43\xb0\xac\xba\x1d\x79\x33\x24\x36\x01\x26\x3e\x9a\x5b\x87\xa2\x12\x09\xb8\x16\xf3\x05\x08\xfb\x89\x65\x70\x43\x8f\xe9\xa8\x91\xb7\x05\x88\xec\xdf\xbe\xb4\xd4\x92\xe0\x70\x95\x5f\x72\x0b\x0a\xb5\xaa\x58\x2c\xce\xe8\x31\xd9\x5a\x69\x0c\x3b\x6b\x32\x70\x66\x52\xb4\x46\x79\x5a\xcf\x31\xc9\x33\xd8\xef\x01\x91\xff\x9c\x0c\xd3\x7e\x14\xc8\xde\x22\x82\xa3\x76\xa8\x25\xc6\xd9\xe3\xaa\x2a\x16\x79\x85\xb7\x95\xe7\x74\xbf\x42\xf1\x2d\x43\x8e\xef\x1d\xc9\x7a\xb5\xff\xa0\xcb\x7e\xfb\x5f\xea\xbc\x26\x72\x00\xc7\x46\x39\xdb\x57\x31\xbe\x1a\xb4\x33\x90\x1d\x7a\x62\x98\x63\x01\x6f\xac\x6d\xf8\x15\xf3\x8a\x45\x17\x9e\x76\x41\x39\xe9\xc4\x58\x67\x0b\x26\x87\x01\x88\x7a\xca\x0b\xb6\x2a\x15\x13\x90\x7d\xe5", 1024);
*(uint64_t*)0x200001f8 = 0x400;
*(uint64_t*)0x20000200 = 0xff;
syz_read_part_table(0, 3, 0x200001c0);
	return 0;
}
