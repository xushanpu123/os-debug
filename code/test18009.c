// autogenerated by syzkaller (https://github.com/google/syzkaller)

#define _GNU_SOURCE 

#include <endian.h>
#include <errno.h>
#include <fcntl.h>
#include <stddef.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/ioctl.h>
#include <sys/mount.h>
#include <sys/stat.h>
#include <sys/syscall.h>
#include <sys/types.h>
#include <unistd.h>

#include <linux/loop.h>

#ifndef __NR_memfd_create
#define __NR_memfd_create 319
#endif

static unsigned long long procid;

struct fs_image_segment {
	void* data;
	uintptr_t size;
	uintptr_t offset;
};
static int setup_loop_device(long unsigned size, long unsigned nsegs, struct fs_image_segment* segs, const char* loopname, int* memfd_p, int* loopfd_p)
{
	int err = 0, loopfd = -1;
	int memfd = syscall(__NR_memfd_create, "syzkaller", 0);
	if (memfd == -1) {
		err = errno;
		goto error;
	}
	if (ftruncate(memfd, size)) {
		err = errno;
		goto error_close_memfd;
	}
	for (size_t i = 0; i < nsegs; i++) {
		if (pwrite(memfd, segs[i].data, segs[i].size, segs[i].offset) < 0) {
		}
	}
	loopfd = open(loopname, O_RDWR);
	if (loopfd == -1) {
		err = errno;
		goto error_close_memfd;
	}
	if (ioctl(loopfd, LOOP_SET_FD, memfd)) {
		if (errno != EBUSY) {
			err = errno;
			goto error_close_loop;
		}
		ioctl(loopfd, LOOP_CLR_FD, 0);
		usleep(1000);
		if (ioctl(loopfd, LOOP_SET_FD, memfd)) {
			err = errno;
			goto error_close_loop;
		}
	}
	*memfd_p = memfd;
	*loopfd_p = loopfd;
	return 0;

error_close_loop:
	close(loopfd);
error_close_memfd:
	close(memfd);
error:
	errno = err;
	return -1;
}

static long syz_mount_image(volatile long fsarg, volatile long dir, volatile unsigned long size, volatile unsigned long nsegs, volatile long segments, volatile long flags, volatile long optsarg, volatile long change_dir)
{
	struct fs_image_segment* segs = (struct fs_image_segment*)segments;
	int res = -1, err = 0, loopfd = -1, memfd = -1, need_loop_device = !!segs;
	char* mount_opts = (char*)optsarg;
	char* target = (char*)dir;
	char* fs = (char*)fsarg;
	char* source = NULL;
	char loopname[64];
	if (need_loop_device) {
		memset(loopname, 0, sizeof(loopname));
		snprintf(loopname, sizeof(loopname), "/dev/loop%llu", procid);
		if (setup_loop_device(size, nsegs, segs, loopname, &memfd, &loopfd) == -1)
			return -1;
		source = loopname;
	}
	mkdir(target, 0777);
	char opts[256];
	memset(opts, 0, sizeof(opts));
	if (strlen(mount_opts) > (sizeof(opts) - 32)) {
	}
	strncpy(opts, mount_opts, sizeof(opts) - 32);
	if (strcmp(fs, "iso9660") == 0) {
		flags |= MS_RDONLY;
	} else if (strncmp(fs, "ext", 3) == 0) {
		if (strstr(opts, "errors=panic") || strstr(opts, "errors=remount-ro") == 0)
			strcat(opts, ",errors=continue");
	} else if (strcmp(fs, "xfs") == 0) {
		strcat(opts, ",nouuid");
	}
	res = mount(source, target, fs, flags, opts);
	if (res == -1) {
		err = errno;
		goto error_clear_loop;
	}
	res = open(target, O_RDONLY | O_DIRECTORY);
	if (res == -1) {
		err = errno;
		goto error_clear_loop;
	}
	if (change_dir) {
		res = chdir(target);
		if (res == -1) {
			err = errno;
		}
	}

error_clear_loop:
	if (need_loop_device) {
		ioctl(loopfd, LOOP_CLR_FD, 0);
		close(loopfd);
		close(memfd);
	}
	errno = err;
	return res;
}

int main(void)
{
		syscall(__NR_mmap, 0x1ffff000ul, 0x1000ul, 0ul, 0x32ul, -1, 0ul);
	syscall(__NR_mmap, 0x20000000ul, 0x1000000ul, 7ul, 0x32ul, -1, 0ul);
	syscall(__NR_mmap, 0x21000000ul, 0x1000ul, 0ul, 0x32ul, -1, 0ul);

memcpy((void*)0x20000000, "ext4\000", 5);
memcpy((void*)0x20000100, "./file0\000", 8);
*(uint64_t*)0x20000200 = 0x20010000;
memcpy((void*)0x20010000, "\x20\x00\x00\x00\x00\x02\x00\x00\x19\x00\x00\x00\x50\x01\x00\x00\x0f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x02\x00\x00\x20\x00\x00\x20\x00\x00\x00\xde\xf4\x65\x5f\xde\xf4\x65\x5f\x01\x00\xff\xff\x53\xef\x01\x00\x01\x00\x00\x00\xdd\xf4\x65\x5f\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x0b\x00\x00\x00\x80\x00\x00\x00\x18\x00\x00\x00\xc2\x05\x00\x00\x2b\x02", 102);
*(uint64_t*)0x20000208 = 0x66;
*(uint64_t*)0x20000210 = 0x400;
*(uint64_t*)0x20000218 = 0x20010100;
memcpy((void*)0x20010100, "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe5\x8c\xa1\x2e\x13\xa2\x40\xe2\xb1\xa2\x2f\x8d\x07\xe8\xe5\x5f\x01\x00\x40", 31);
*(uint64_t*)0x20000220 = 0x1f;
*(uint64_t*)0x20000228 = 0x4e0;
*(uint64_t*)0x20000230 = 0x20010200;
memcpy((void*)0x20010200, "\x01\x00\x00\x00\x00\x00\x05\x00\x40", 9);
*(uint64_t*)0x20000238 = 9;
*(uint64_t*)0x20000240 = 0x560;
*(uint64_t*)0x20000248 = 0x20010300;
memcpy((void*)0x20010300, "\x03\x00\x00\x00\x04\x00\x00\x00\x05\x00\x00\x00\x15\x00\x0f", 15);
*(uint64_t*)0x20000250 = 0xf;
*(uint64_t*)0x20000258 = 0x800;
*(uint64_t*)0x20000260 = 0x20010400;
memcpy((void*)0x20010400, "\xff\x07\x00\x00\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff", 1026);
*(uint64_t*)0x20000268 = 0x402;
*(uint64_t*)0x20000270 = 0xc00;
*(uint64_t*)0x20000278 = 0x20010d00;
memcpy((void*)0x20010d00, "\xed\x41\x00\x00\x00\x04\x00\x00\xdd\xf4\x65\x5f\xde\xf4\x65\x5f\xde\xf4\x65\x5f\x00\x00\x00\x00\x00\x00\x04\x00\x20", 29);
*(uint64_t*)0x20000280 = 0x1d;
*(uint64_t*)0x20000288 = 0x1480;
*(uint64_t*)0x20000290 = 0x20012000;
memcpy((void*)0x20012000, "\x50\x4d\x4d\x00\x50\x4d\x4d\xff", 8);
*(uint64_t*)0x20000298 = 8;
*(uint64_t*)0x200002a0 = 0x10000;
*(uint8_t*)0x20012b00 = 0;
syz_mount_image(0x20000000, 0x20000100, 0x80000, 7, 0x20000200, 0, 0x20012b00, 0);
memcpy((void*)0x20000040, "./file0\000", 8);
memcpy((void*)0x20000080, "trusted.overlay.upper\000", 22);
*(uint8_t*)0x200004c0 = 0;
*(uint8_t*)0x200004c1 = 0xfb;
*(uint8_t*)0x200004c2 = 0x81;
*(uint8_t*)0x200004c3 = 0;
*(uint8_t*)0x200004c4 = 0;
memcpy((void*)0x200004c5, "\x0c\x54\xd1\x4c\xba\x52\xc0\x32\x22\x5f\xcb\x7b\x82\x8c\xf2\xfb", 16);
memcpy((void*)0x200004d5, "\x10\x9e\x57\xfd\x11\x27\x50\x51\xf2\x2c\x52\x32\x08\x55\x2b\x43\xfd\x68\x2b\x59\xac\x67\xfc\xb8\xae\x6f\x90\x66\xc0\x75\x8a\xf6\x1a\x6c\xc0\xbe\xb2\xc8\xbd\x0a\x52\xde\xd9\xbe\x3c\xf4\xa9\x63\xd6\x28\x35\xf6\x98\xcc\x6d\x8a\xa2\x3a\x1f\xc2\x92\xab\x5c\xf4\x7f\xab\x61\x05\xa2\xac\xb6\x35\x2d\x2a\x97\x85\x40\x9e\x8e\xc1\xff\x41\xa3\x6a\x24\x26\xf0\xc3\x98\xbe\x37\x29\x08\x3c\x16\xc8\x04\xdc\x5d\x74\x1f\x55\x8a\x3d\x84\x91\x80\x3f\xf4\x77\xdb\x08\xfb\x16\xa5\xdd\x71\xb0\xd3\x46\x54\xc2\x2b\xf5\x95\xeb\xee\x92\xa4\xa6\xb4\xc5\x79\x99\xf9\x5b\x21\x19\xe4\x60\x77\x60\x3c\x0e\xa7\x0e\xfc\x7b\x09\x52\x16\xbd\x53\xae\xfd\x06\x7c\xf6\x5d\x66\x7f\xa7\x16\x57\xe7\x66\x38\xe6\xb2\x31\x29\xa7\x0f\xdd\xb3\xd2\x38\xb2\x1d\x68\x26\xfa\x38\xbd\x05\x6d\xe0\x1c\xdf\xd6\x5a\x1f\xf1\x46\x1b\x2c\x24\x7f\x3b\xfe\x8c\x7a\x0b\x80\x50\xb7\xca\xa9\x14\x88\x36\x5c\xcc\xfa\x30\xa8\x3d\x2d\x9f\x73\xaf\x03\xdc\x09\x45\x4b\x7e\x0e\xce\x1b\xed\x4b\x1b\x96\xa6\xa1\x95\xd7\xef\x0b\x94\xdf\x89\xf7\x4c\x18\x93\x3b\xe6\x73\xab\x5c\x22\x94\x30\x92\x2b\x6c\x0e\xff\x06\x18\xd7\x23\x5d\x7d\x00\x36\x40\x1f\x36\x91\xbd\x85\x5a\x0e\x85\xab\x6e\xeb\xcd\x3c\xcd\x23\x05\x26\xd6\x77\x81\x2c\xa0\x43\x3a\x47\x9c\x73\x5e\xbc\xa6\xff\x4d\x72\xa6\x0c\xf3\xbe\x13\xd1\xf5\x0c\xdd\x77\x41\x22\x28\x9d\x57\x5b\x37\x6f\xa9\x30\xd7\x36\x98\x8b\xe1\xf6\x5e\xec\x9a\x5b\x95\x93\xd2\x39\xe7\x90\x11\x4b\xe4\x32\x8e\x21\x0c\x8a\x36\x17\x0d\x33\xdd\xc4\x47\x15\x7f\x7d\xc6\x62\x5e\x1f\xdc\x37\x2c\xa4\x99\x1f\xba\xcd\x04\xbe\x87\xdb\x74\xb2\x7d\xab\x3a\x91\x33\x7e\xab\x93\x34\x40\xc9\xc8\x66\x8b\x0f\xb4\x0b\xb9\x24\xe1\x56\xd5\xa8\x29\x80\xb5\x5d\x9a\x75\xc9\x79\x7e\x75\x67\xa4\x36\xc7\x15\x06\x8d\xe8\xb6\xf8\x2a\x92\x0f\xe1\x6d\xcb\x06\xde\x3b\x2f\xf8\xf0\xba\x67\xcf\x2c\x3f\xa5\xb1\x5e\xac\x01\xb9\x08\x40\xb2\xcc\xbe\x20\x9d\x6c\x68\xf4\x4b\x93\xd4\x71\xc2\x9a\x0f\xda\xa0\x51\x4b\xb6\x82\xdc\xd1\x74\xfb\x6f\x50\x3f\x4d\x3d\x09\xae\x9d\xbb\xe0\xfb\xb5\xf8\x7b\x20\xef\xfb\x35\x60\x74\x87\x6e\x33\x3f\x99\xdd\xe9\x73\x17\xd1\x3d\x34\x46\x9d\xb5\xae\x81\x25\xa3\x84\x02\x12\x60\xe8\x48\x69\x43\x00\x96\xff\x2e\xfd\x62\x2d\x0e\xc7\xf5\x2c\xbb\x8b\xd9\x50\x3e\xf4\x7e\xbc\x0a\x15\xcb\x19\x87\xa9\x10\x4a\x87\x0b\xeb\xfe\xf2\x5e\xfc\x27\x0d\x85\x76\x3f\x9c\xe5\xae\x4b\x26\x4a\x48\x0a\xd7\x3b\x05\x85\x06\x36\xce\x76\x40\xe4\xa4\x7b\x82\xe2\x1c\x2f\x1b\x93\xea\x4b\xed\x92\x22\x81\x52\xb9\x9b\xf0\x64\xaf\x09\xbb\x64\x83\x97\x69\xbb\xeb\xac\x72\xe1\x78\x8c\x56\x1b\x6c\xe2\xd8\x3e\x8d\x22\x73\x35\x83\x81\x4e\x5f\xbd\x3e\x6c\x39\x77\xda\x2d\x73\x6e\x2b\xe5\xc3\x1a\x0d\x8f\x6d\x9e\xed\x1a\x24\x15\xd5\x39\xc5\x7d\x3a\xa4\x32\xbc\xcf\x8a\x14\x4f\x70\x73\x55\xf7\x0a\x68\xfe\xbe\xff\x58\x7d\x3f\xae\xf3\x43\xa4\xe8\x80\x04\x1e\x00\x61\xbf\xa0\x18\x76\x2f\xb3\xa2\x92\x3b\xbb\x08\xb4\x95\x4e\xe7\xf7\x9b\x95\xb7\x35\xd2\x30\x64\xc5\x16\x64\x38\x34\x07\x82\x6b\xac\x8a\xb4\xc5\x07\xe8\xe9\x85\x4a\x89\x80\xa7\x43\x99\x29\x99\x83\x0e\xd2\xbc\x44\xa7\xb7\x16\x5d\x3b\xd0\x36\x3d\x39\x49\x26\x82\x85\x3a\x74\x08\x49\x9a\x6e\x57\xed\x0f\x15\x1b\x1d\x0a\x5d\x07\x78\x9b\xf9\x4e\x4c\x1d\xc7\x36\x6b\x39\xbc\x90\x3b\x4f\xf3\xbe\xe7\x94\x1b\xac\xd5\x9c\x61\xb3\x4f\x4b\x94\xdf\xc5\x33\x21\xfb\x87\xab\x26\x91\x38\xec\x02\xcf\x0d\x2a\xa7\xcb\x86\xda\x7c\x1f\x6b\x6b\x19\xfe\xf8\x08\xa2\x46\x24\x08\xf9\xc7\x15\x31\x20\x73\x35\x4e\x2a\xf7\x58\xb5\xc3\xa3\xdf\x0f\x94\xb1\x28\x30\x90\x94\x88\xe6\x09\x21\x73\x52\x51\x64\x1d\xe1\x79\x7b\x6b\x8e\x77\xfc\xb9\x12\xe0\x03\xde\x28\x78\x95\x2d\xae\xdc\x30\x20\xf6\xda\x76\xca\x63\x8a\xb0\x40\xde\x49\x2a\x72\x17\xb9", 876);
	syscall(__NR_setxattr, 0x20000040ul, 0x20000080ul, 0x200004c0ul, 0x381ul, 0ul);
memcpy((void*)0x200000c0, "./file0\000", 8);
memcpy((void*)0x20000140, "trusted.overlay.upper\000", 22);
	syscall(__NR_setxattr, 0x200000c0ul, 0x20000140ul, 0ul, 0ul, 0ul);
	return 0;
}
