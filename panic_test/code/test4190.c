// autogenerated by syzkaller (https://github.com/google/syzkaller)

#define _GNU_SOURCE 

#include <endian.h>
#include <errno.h>
#include <fcntl.h>
#include <stddef.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/ioctl.h>
#include <sys/mount.h>
#include <sys/stat.h>
#include <sys/syscall.h>
#include <sys/types.h>
#include <unistd.h>

#include <linux/loop.h>

#ifndef __NR_memfd_create
#define __NR_memfd_create 319
#endif

static unsigned long long procid;

static long syz_open_procfs(volatile long a0, volatile long a1)
{
	char buf[128];
	memset(buf, 0, sizeof(buf));
	if (a0 == 0) {
		snprintf(buf, sizeof(buf), "/proc/self/%s", (char*)a1);
	} else if (a0 == -1) {
		snprintf(buf, sizeof(buf), "/proc/thread-self/%s", (char*)a1);
	} else {
		snprintf(buf, sizeof(buf), "/proc/self/task/%d/%s", (int)a0, (char*)a1);
	}
	int fd = open(buf, O_RDWR);
	if (fd == -1)
		fd = open(buf, O_RDONLY);
	return fd;
}

struct fs_image_segment {
	void* data;
	uintptr_t size;
	uintptr_t offset;
};
static int setup_loop_device(long unsigned size, long unsigned nsegs, struct fs_image_segment* segs, const char* loopname, int* memfd_p, int* loopfd_p)
{
	int err = 0, loopfd = -1;
	int memfd = syscall(__NR_memfd_create, "syzkaller", 0);
	if (memfd == -1) {
		err = errno;
		goto error;
	}
	if (ftruncate(memfd, size)) {
		err = errno;
		goto error_close_memfd;
	}
	for (size_t i = 0; i < nsegs; i++) {
		if (pwrite(memfd, segs[i].data, segs[i].size, segs[i].offset) < 0) {
		}
	}
	loopfd = open(loopname, O_RDWR);
	if (loopfd == -1) {
		err = errno;
		goto error_close_memfd;
	}
	if (ioctl(loopfd, LOOP_SET_FD, memfd)) {
		if (errno != EBUSY) {
			err = errno;
			goto error_close_loop;
		}
		ioctl(loopfd, LOOP_CLR_FD, 0);
		usleep(1000);
		if (ioctl(loopfd, LOOP_SET_FD, memfd)) {
			err = errno;
			goto error_close_loop;
		}
	}
	*memfd_p = memfd;
	*loopfd_p = loopfd;
	return 0;

error_close_loop:
	close(loopfd);
error_close_memfd:
	close(memfd);
error:
	errno = err;
	return -1;
}

static long syz_mount_image(volatile long fsarg, volatile long dir, volatile unsigned long size, volatile unsigned long nsegs, volatile long segments, volatile long flags, volatile long optsarg, volatile long change_dir)
{
	struct fs_image_segment* segs = (struct fs_image_segment*)segments;
	int res = -1, err = 0, loopfd = -1, memfd = -1, need_loop_device = !!segs;
	char* mount_opts = (char*)optsarg;
	char* target = (char*)dir;
	char* fs = (char*)fsarg;
	char* source = NULL;
	char loopname[64];
	if (need_loop_device) {
		memset(loopname, 0, sizeof(loopname));
		snprintf(loopname, sizeof(loopname), "/dev/loop%llu", procid);
		if (setup_loop_device(size, nsegs, segs, loopname, &memfd, &loopfd) == -1)
			return -1;
		source = loopname;
	}
	mkdir(target, 0777);
	char opts[256];
	memset(opts, 0, sizeof(opts));
	if (strlen(mount_opts) > (sizeof(opts) - 32)) {
	}
	strncpy(opts, mount_opts, sizeof(opts) - 32);
	if (strcmp(fs, "iso9660") == 0) {
		flags |= MS_RDONLY;
	} else if (strncmp(fs, "ext", 3) == 0) {
		if (strstr(opts, "errors=panic") || strstr(opts, "errors=remount-ro") == 0)
			strcat(opts, ",errors=continue");
	} else if (strcmp(fs, "xfs") == 0) {
		strcat(opts, ",nouuid");
	}
	res = mount(source, target, fs, flags, opts);
	if (res == -1) {
		err = errno;
		goto error_clear_loop;
	}
	res = open(target, O_RDONLY | O_DIRECTORY);
	if (res == -1) {
		err = errno;
		goto error_clear_loop;
	}
	if (change_dir) {
		res = chdir(target);
		if (res == -1) {
			err = errno;
		}
	}

error_clear_loop:
	if (need_loop_device) {
		ioctl(loopfd, LOOP_CLR_FD, 0);
		close(loopfd);
		close(memfd);
	}
	errno = err;
	return res;
}

int main(void)
{
		syscall(__NR_mmap, 0x1ffff000ul, 0x1000ul, 0ul, 0x32ul, -1, 0ul);
	syscall(__NR_mmap, 0x20000000ul, 0x1000000ul, 7ul, 0x32ul, -1, 0ul);
	syscall(__NR_mmap, 0x21000000ul, 0x1000ul, 0ul, 0x32ul, -1, 0ul);

syz_open_procfs(-1, 0);
*(uint64_t*)0x20001a00 = 0x20000900;
memcpy((void*)0x20000900, "\x64\x6d\xcf\x00\xe3\x4a\xac\x4c\xae\x95\xaf\x6c\x61\x48\x41\x5a\x9b\x3d\xb5\x20\x3d\x3f\xa6\xe5\x2d\x79\x02\x71\xeb\x45\xab\x4b\xd9\x34\x55\xe2\xbc\x74\x70\xca\xb7\xee\x23\x64\x37\x14\x5a\x04\xa5\xc2\xec\xe5\x71\xda\x1b\xbc\xc9\x21\xd3\x5f\xa3\x6e\x5c\x0c\x21\xf7\x19\x7b\xab\xb7\x50\xc1\x77\xa2\x4e\x4f\x25\x31\xa6\x45\xd5\xcd\x30\xb6\x5e\x4d\x34\x0e\x42\x15\x81\xc4\x94\x8d\xea\x75\x48\x6c\x71\x65\x5e\x19\x7d\xd7\x6f\x70\x7e\xd2\xcc\x1b\x95\xf9\x57\x54\x88\xdf\x0c\xcf\xc5\xe9\xc3\xa7\x7f\xd3\x6c\x76\xdc\xfa\xc8\x3b\xf5\x2a\x39\x66\xd1\x85\x59\x99\x1b\xbd\xac\x14\x5b\xd3\xf8\x25\x27\x46\xef\x5a\x77\x58\x71\x10\xf8\x07\xd6\x42\x3b\x98\x02\xc9\xd9\x2e\x54\xd9\x84\xff\x5a\x76\xc8\xe2\x2e\x8d\xac\xcc\x89\xc5\x4f\x47\x7f\xa7\xe9\xb8\x77\x21\x5c\xf5\x59\x73\x8c\x85\xa4\xd7\xe4\xa5\xea\xfb\x59\xa0\x7f\xe7\x4e\x69\x06\xb9\x14\x4f\xeb\x44\x2f\x43\x10\x86\xe0\xa1\x7b\x3b\xf7\xcb\x97\x4e\x09\x5f\xf7\x50\x44\xac\xf4\x4c\xa8\xf2\xda\x8a\x24\x81\xb5\x5a\x3b\xeb\x25\x0a\x0e\xb6\xd2\x41\xf8\x5c\x9c\x57\xe4\x75\x5e\xf8\x22\x1e\xd5\xfe\xc4\x42\x5c\x2a\xa5\x64\xb0\x19\x05\x61\xbe\x3f\xb1\x43\x48\xc7\xbf\x10\x47\xd0\x20\x49\x20\x5a\x05\xa6\xb4\x49\x37\x52\x21\xcc\x5f\xc2\xa2\xb9\x9f\x52\x66\x59\xef\xc5\x44\xb8\x73\x87\x7e\x8a\xd6\x87\x72\x81\x71\xb7\x24\xc5\xd7\xa5\x04\x1b\xc1\x01\x5e\x3a\x2a\x9c\xad\x12\x1b\x1f\x95\x59\xb8\x25\x77\x68\xc0\x2e\x35\x4f\x26\xf2\x31\xb8\xb7\x85\x19\x51\xe5\xa2\x19\x31\xe6\x99\x88\x54\xb3\x11\xbc\xaa\x7e\x2d\x25\x5b\x27\x15\xd7\x13\xb5\x96\xcc\x4f\x62\x49\xf2\xa2\x6b\xb6\x2b\xc0\xf6\x6b\x31\xe5\xe9\xe3\xcf\xfa\x91\x55\x63\x90\xe7\x83\x5c\x93\xf7\x6f\x50\xcc\x61\x3b\x6a\x75\x42\x0a\x4d\x58\x08\xd7\xe8\x0e\xe5\xf9\x28\x02\x79\x70\x8b\x30\x8b\x1c\x96\x0d\x4b\xca\xc6\xd2\xf1\x13\x85\x7a\x89\x3a\xb3\xc0\x97\x13\x0c\xd0\x81\x85\xe3\x10\x81\x92\xe8\xa4\x0f\x5d\x23\xb0\xdc\x1f\xe8\x67\xd6\x6f\x7e\x4a\x91\x19\xb2\xbe\xa3\xbe\xd3\x53\x87\x39\xb3\xee\x64\xaf\xe1\xe1\x7e\xbb\xdb\xfc\xca\x68\x99\x78\x02\x5d\x6f\x61\xee\x84\x40\xd9\x5e\x1f\x9d\x27\xf7\x9d\x2f\xb4\x24\x80\xab\x1b\xf5\x07\x1c\xaf\xdf\xf1\xdc\x59\x93\x1a\xb5\xb7\x73\x8a\x0c\xe9\x63\x20\x71\x09\x09\xf9\x92\x3a\x1f\xac\x9a\x9a\xc9\xba\x10\xf1\x3e\x4e\x52\x9b\xb2\xb0\x46\x79\x55\x55\x79\x12\x4d\xf9\x37\xa8\x63\xaa\xf9\xd2\x8e\xfa\x05\x0c\xe0\xbf\x5f\x13\xca\x3d\x73\x3b\x30\xbc\x85\x30\xc7\xbc\xfd\xb8\x6b\x10\x74\xde\xe9\xff\x22\x04\x89\x98\x4b\xc3\xab\x84\x81\xf6\xa2\x8b\x8e\xf4\x44\xd4\x37\x34\xde\x2e\x16\x34\x73\x1b\xda\x53\xae\x24\x9c\x04\x4f\x0a\x3c\xde\x04\x66\x1a\xc8\xbe\x47\xeb\x5a\x8c\x81\xd6\x3d\x74\xf1\x50\x62\x90\xac\xa7\x27\xcd\x13\x5b\x83\x5f\x8f\xcb\x21\x31\x1f\xbe\x62\x6c\x23\xa5\x4e\x25\x2e\x7f\x8b\xea\x8e\xa5\xbb\xe0\x02\x30\x7f\x4d\xb0\xa4\x30\xf3\x9a\xde\xac\xd9\x82\x33\x84\xf1\xed\xc1\x9d\x19\x7f\x79\x37\x5e\x0a\x2a\xcf\x48\x4e\x3e\xbc\xe7\xea\x6a\xcb\x1c\x8d\xdf\x48\x96\x86\xa1\x70\xf0\xd1\xa6\x25\x26\xf5\x2d\x89\xa7\xf1\xf5\x61\xe2\x4d\xae\x7d\x9e\x66\xb1\xab\x90\xe9\xef\xad\x51\x9a\x17\xfd\x1d\xfd\x90\x8f\xb8\x6c\xfa\xc8\x7e\xc0\x9f\x85\x73\xbd\x48\xfd\x9f\x2a\xcf\x36\xd0\xc2\x8d\xc0\xbf\xf1\xb8\xe7\xba\x60\x95\x38\xe0\x34\x61\xd9\xbf\xf9\x66\x09\xe2\x79\x5a\x2f\x1b\x50\x7d\xe4\x92\x0e\x7e\x88\x25\x1c\xdf\x05\xff\xf2\x32\xf6\xa2\xda\x41\xcd\xfe\x63\x6c\x1f\xc0\xc3\x84\x7f\x3f\xb3\xb6\x6a\x91\xbd\x35\xa1\x05\xb8\x6a\x5b\xc8\x40\x9a\xa9\x56\x5d\x80\x17\x49\xdf\xe6\xf1\x9e\x26\x48\x0e\x6b\xd7\x10\xa3\xc0\xbf\x89\x1b\x2d\x0a\x47\xa9\xb2\x7c\x17\x39\xa3\x90\x1b\x83\x94\xbb\x41\x1a\x60\x26\xf0\x2f\x38\x09\x7d\xa3\x15\x77\x89\x53\x37\xa0\xff\xdd\x98\x8f\x48\x1c\x95\x31\x5a\x8c\x97\xf7\xec\x5b\x15\x97\xda\x5d\x28\x25\xc1\x1f\x6e\x73\x91\x22\xad\xad\x4e\x36\x00\x17\xaa\xf0\xb5\xf7\x05\x97\xed\x12\xcb\xcf\x0a\xde\x1a\xa1\xa9\xa4\xa0\x2f\x1a\x91\xe8\x7c\xf4\x29\x49\x41\x8c\x48\xc9\xd0\x58\x8d\x14\x4c\x9f\xe3\x09\x5d\x56\x6a\x02\x9e\xdb\x0e\xd1\x59\x77\x23\xa6\x79\x22\x32\xd1\x5f\xda\x77\x3c\x10\x68\xd0\xa2\xf2\xce\xa3\x95\xe8\xf8\x41\xe9\x06\x5e\x6e\x9a\x57\x06\xbd\x21\x09\x6e\x18\x98\x98\x40\xd3\xb1\xec\xcd\x14\x33\x97\x61\x6d\x61\x43\x01\xf4\x79\xd6\x30\xae\x2d\x0e\x6d\x6d\xca\xf1\xcb\x23\xe2\x3c\xd2\xcb\x18\xa7\x5d\x5c\xcc\x2e\xf6\xc7\x2d\x48\xa7\x5b\xf3\x19\xdd\x56\xff\x03\xb1\x81\x32\x86\x4b\x65\xaf\xeb\x13\x73\xb9\xfe\x1d\xee\x49\xdb\xb5\xff\x61\xfe\x77\x7a\xb2\x8e\xe6\x48\xcd\xbc\x24\xe7\x5a\x08\x65\x20\x25\xd2\xe7\xb1\x21\x10\xdd\x93\x17\x0b\xb8\xf3\xa2\x1a\x1a\x72\x9e\xb3\x5c\xe0\xb5\x34\xc3\x62\xb8\x9c\x06\xc5\xbf\x6e\x9c\x8a\xb8\x44\x11\x3b\x4d\x3f\xac\x9b\x8b\x34\x24\x6b\xdb\x7f\x22\x49\xba\x27\x9b\x8f\xd5\xaa\x53\x59\x48\x8f\x0d\xa1\xa5\xa4\x3a\xd2\x2f\xf9\x29\xcb\x44\x9c\x50\xb0\x12\x53\x0d\x48\x91\x3d\x2b\xeb\x2a\xfa\xcd\xdc\xab\xb0\xe2\x10\x0a\x3a\x55\x4c\x3f\x3e\x08\x22\xf8\x4f\x19\x74\x7f\x71\xe2\x0c\xc0\x19\x73\x74\x53\xdb\xac\x3a\x28\xcc\x53\xea\xca\x37\xe0\x7f\xbc\x03\xa1\xcb\xa8\x2a\xc8\x65\x54\x94\x00\x75\x20\xeb\xcc\x1b\x3d\x0d\xa4\x8f\xc1\xf3\x7a\xb6\x17\x7c\x78\x30\xbe\xb1\xc3\x77\x13\x21\x63\xb4\x01\xaa\xdf\x3d\xfb\x90\xa7\xc5\xd2\xc8\x91\x3e\x0e\x17\xe4\x1e\x06\x26\x94\xa0\x69\xb7\x19\xb9\xf1\xfa\xe6\xd1\xdf\x52\x29\x2c\x7b\x04\xbc\xe5\x21\xd6\x1a\x4d\x9f\x1d\x25\x07\x29\x41\x46\x31\x73\xc6\x86\xd4\xde\x20\xa8\x4b\x1a\xa3\x74\xfe\xa8\xd3\x29\x94\x69\x32\x27\xd7\x93\x2b\x39\x21\x96\x75\x96\xe5\x18\xda\x04\x47\x21\x1b\x91\x91\xc9\xc8\x0d\xed\xd6\xa0\xbd\xba\x98\xe0\xf4\x4a\x78\xf0\xcc\xaa\x60\x44\x4b\x25\xf8\x51\xf5\x98\xf4\x5e\xa5\x13\x95\xab\xa2\x7c\x1e\x43\xd0\x78\x40\xda\x7c\xd7\x5b\x96\xcb\x57\x79\x16\xd7\x63\x70\x3e\xde\x2b\x17\x85\xf7\x51\x23\x77\x8e\xbe\xad\x79\xce\x31\xc2\x99\x79\x73\x14\x0d\x39\x12\xa4\x6e\xad\x7e\x9b\xf7\xd0\xa0\x2e\x4c\x35\x1a\x18\xfb\xc7\x33\x5f\x47\x82\x40\x97\x47\x7f\x7b\xa0\x2e\x5c\x96\xeb\x05\x60\xd4\x2f\x52\x06\xc3\xb3\x23\xfb\x61\x8c\x30\xb2\x37\x38\x73\xf0\x7c\xb9\x60\x98\xd5\x64\x89\x1d\xee\x14\x96\x75\x61\x83\xeb\x49\xf3\xb0\x80\xd8\xfd\x8f\x80\xe6\xf4\xe4\xdb\x49\x6a\x24\x6e\xc7\xfc\x02\x51\xbf\xe2\xe5\x09\x50\xb8\x95\x8d\x9e\x7d\x19\x36\x63\x56\x6e\x75\xae\xa3\x6d\x5a\x82\xc3\xd2\xad\xae\xd3\xbd\x55\xa8\xaf\xd3\x28\xb9\x3e\x11\x2a\xd0\xa0\x5c\x69\x03\x39\xe8\x7f\x75\xe0\x75\x0f\x2e\x8f\x0e\xbb\x1d\x99\x37\x56\xc9\xe5\x89\xfc\xd8\x00\x73\x88\xf7\xc9\x5b\x96\x95\xa5\x62\x16\x00\x63\x8e\x2c\x66\xef\xd7\x81\xcf\x5b\x7e\x12\xa9\x90\x31\x35\x8b\xab\xe9\xf5\xb1\x46\x57\x1f\xf6\xd0\x0d\x8b\x64\xf8\x37\x6e\xa2\x75\x31\xfe\x46\x39\xd7\xe6\x7d\x99\x2f\x1a\x5c\x7b\x97\x27\x36\xa8\x44\xdc\x5e\xde\xc3\x06\xf8\x8c\xe3\xb9\xc3\x7e\x97\x2e\x58\x7f\xbc\x59\xbe\x56\xdb\xf5\x52\x1f\xe9\xc5\x59\xd0\x8a\x8b\xb0\x9a\x69\x0b\xfe\x5e\x13\x2e\x61\xe4\xff\xd6\x72\xa4\x91\x67\x05\x0c\x74\xbe\xe0\xea\x6a\x00\xcd\x8d\xc1\x5e\xfa\x00\xb8\x0e\xfe\x29\x5e\x28\x80\xf3\x10\xc1\x5d\xf7\x5a\x50\xf6\x31\x9e\xa5\xc7\xe8\xa8\xfe\x44\x95\xf0\x83\x2f\xdc\x48\xfc\x68\xa4\x4e\x88\xdf\x7e\xa6\xc8\x98\x78\xe0\xe8\x46\xa8\xde\xcd\x96\x9a\x15\xe8\x11\x67\x6c\xfb\xd6\xa9\x19\xbf\x26\x57\x44\x01\x13\xd6\x32\x25\xd2\xc3\xa1\x2f\x86\xd5\x28\xd4\xec\xb3\x7c\xb2\xca\xa0\x1b\x7f\x6a\x1f\x15\x77\xc8\x10\x8b\x10\xf3\x65\x87\x20\xdb\x80\xb1\xbf\x58\xe2\x1a\x6a\xe6\x76\xa9\x7b\xbd\x40\xe1\x99\x46\xad\xbd\xa0\x8a\x59\x83\x9f\x66\xb3\xea\x29\x75\xf9\x7c\x1a\x4c\xc8\xf0\x75\xde\x82\xaa\xcb\x8c\x36\xf9\xe8\x83\x81\x6a\xbb\xf6\x46\x66\x8a\x41\x94\x1c\x69\x7b\x95\x04", 1793);
*(uint64_t*)0x20001a08 = 0x701;
*(uint64_t*)0x20001a10 = 0;
syz_mount_image(0, 0, 0x701, 1, 0x20001a00, 0, 0, 0);
	return 0;
}
